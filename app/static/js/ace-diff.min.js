/*!
* ace-diff
* @author Ben Keen
* @version 0.1.0
* @date Mar 21, 2015
* @repo http://github.com/benkeen/ace-diff
*/
!function(a,b){"function"==typeof define&&define.amd?define([],b):"object"==typeof exports?module.exports=b(require()):a.AceDiff=b(a)}(this,function(){"use strict";function a(a){this.options={},A(!0,this.options,{mode:null,theme:null,diffGranularity:G.DIFF_GRANULARITY_BROAD,lockScrolling:!1,showDiffs:!0,showConnectors:!0,maxDiffs:5e3,left:{id:"acediff-left-editor",content:null,mode:null,theme:null,editable:!0,copyLinkEnabled:!0},right:{id:"acediff-right-editor",content:null,mode:null,theme:null,editable:!0,copyLinkEnabled:!0},classes:{gutterID:"acediff-gutter",diff:"acediff-diff",connector:"acediff-connector",newCodeConnectorLink:"acediff-new-code-connector-copy",newCodeConnectorLinkContent:"&#8594;",deletedCodeConnectorLink:"acediff-deleted-code-connector-copy",deletedCodeConnectorLinkContent:"&#8592;",copyRightContainer:"acediff-copy-right",copyLeftContainer:"acediff-copy-left"},connectorYOffset:0},a),this.editors={left:{ace:ace.edit(this.options.left.id),markers:[],lineLengths:[]},right:{ace:ace.edit(this.options.right.id),markers:[],lineLengths:[]},editorHeight:null},d(this),this.lineHeight=this.editors.left.ace.renderer.lineHeight,this.editors.left.ace.getSession().setMode(b(this,G.EDITOR_LEFT)),this.editors.right.ace.getSession().setMode(b(this,G.EDITOR_RIGHT)),this.editors.left.ace.setReadOnly(!this.options.left.editable),this.editors.right.ace.setReadOnly(!this.options.right.editable),this.editors.left.ace.setTheme(c(this,G.EDITOR_LEFT)),this.editors.right.ace.setTheme(c(this,G.EDITOR_RIGHT)),v(this),t(this),this.options.left.content&&this.editors.left.ace.setValue(this.options.left.content,-1),this.options.right.content&&this.editors.right.ace.setValue(this.options.right.content,-1),this.editors.editorHeight=B(this),this.diff()}function b(a,b){var c=a.options.mode;return b===G.EDITOR_LEFT&&null!==a.options.left.mode&&(c=a.options.left.mode),b===G.EDITOR_RIGHT&&null!==a.options.right.mode&&(c=a.options.right.mode),c}function c(a,b){var c=a.options.theme;return b===G.EDITOR_LEFT&&null!==a.options.left.theme&&(c=a.options.left.theme),b===G.EDITOR_RIGHT&&null!==a.options.right.theme&&(c=a.options.right.theme),c}function d(a){var b,c=(new Date).getTime(),d=(new Date).getTime();a.editors.left.ace.getSession().on("changeScrollTop",function(c){b=(new Date).getTime(),b>d+50&&h(a,"left",c)}),a.editors.right.ace.getSession().on("changeScrollTop",function(d){b=(new Date).getTime(),b>c+50&&h(a,"right",d)});var f=a.diff.bind(a);a.editors.left.ace.on("change",f),a.editors.right.ace.on("change",f),a.options.left.copyLinkEnabled&&D("#"+a.options.classes.gutterID,"click","."+a.options.classes.newCodeConnectorLink,function(b){e(a,b,G.LTR)}),a.options.right.copyLinkEnabled&&D("#"+a.options.classes.gutterID,"click","."+a.options.classes.deletedCodeConnectorLink,function(b){e(a,b,G.RTL)});var g=E(function(){a.editors.availableHeight=document.getElementById(a.options.left.id).offsetHeight,a.diff()},250);window.addEventListener("resize",g)}function e(a,b,c){var d,e,f,g,h,i,j=parseInt(b.target.getAttribute("data-diff-index"),10),k=a.diffs[j];c===G.LTR?(d=a.editors.left,e=a.editors.right,f=k.leftStartLine,g=k.leftEndLine,h=k.rightStartLine,i=k.rightEndLine):(d=a.editors.right,e=a.editors.left,f=k.rightStartLine,g=k.rightEndLine,h=k.leftStartLine,i=k.leftEndLine);for(var l="",m=f;g>m;m++)l+=p(d,m)+"\n";for(var n="",m=0;h>m;m++)n+=p(e,m)+"\n";for(var o="",q=e.ace.getSession().getLength(),m=i;q>m;m++)o+=p(e,m),q-1>m&&(o+="\n");o=o.replace(/\s*$/,"");var r=e.ace.getSession().getScrollTop();e.ace.getSession().setValue(n+l+o),e.ace.getSession().setScrollTop(parseInt(r)),a.diff()}function f(a){var b=a.ace.getSession().doc.getAllLines(),c=[];return b.forEach(function(a){c.push(a.length+1)}),c}function g(a,b,c,d,e){var b=a.editors[b];c>d&&(d=c);var f=e+" "+(d>c?"lines":"targetOnly");d--,b.markers.push(b.ace.session.addMarker(new F(c,0,d,1),f,"fullLine"))}function h(a){i(a),z(a),l(a)}function i(a){a.editors.left.markers.forEach(function(a){this.editors.left.ace.getSession().removeMarker(a)},a),a.editors.right.markers.forEach(function(a){this.editors.right.ace.getSession().removeMarker(a)},a)}function j(a,b,c,d,e){var f=a.editors.left.ace.getSession().getScrollTop(),g=a.editors.right.ace.getSession().getScrollTop();a.connectorYOffset=1;var h=-1,i=b*a.lineHeight-f+.5,j=a.gutterWidth+1,k=d*a.lineHeight-g+.5,l=-1,m=c*a.lineHeight-f+a.connectorYOffset+.5,n=a.gutterWidth+1,o=e*a.lineHeight-g+a.connectorYOffset+.5,p=C(h,i,j,k),q=C(n,o,l,m),r="L"+j+","+k+" "+n+","+o,s="L"+l+","+m+" "+h+","+i,t=p+" "+r+" "+q+" "+s,u=document.createElementNS(G.SVG_NS,"path");u.setAttribute("d",t),u.setAttribute("class",a.options.classes.connector),a.gutterSVG.appendChild(u)}function k(a,b,c){if(b.leftEndLine>b.leftStartLine&&a.options.left.copyLinkEnabled){var d=s({className:a.options.classes.newCodeConnectorLink,topOffset:b.leftStartLine*a.lineHeight,tooltip:"Copy to right",diffIndex:c,arrowContent:a.options.classes.newCodeConnectorLinkContent});a.copyRightContainer.appendChild(d)}if(b.rightEndLine>b.rightStartLine&&a.options.right.copyLinkEnabled){var d=s({className:a.options.classes.deletedCodeConnectorLink,topOffset:b.rightStartLine*a.lineHeight,tooltip:"Copy to left",diffIndex:c,arrowContent:a.options.classes.deletedCodeConnectorLinkContent});a.copyLeftContainer.appendChild(d)}}function l(a){var b=a.editors.left.ace.getSession().getScrollTop(),c=a.editors.right.ace.getSession().getScrollTop();a.copyRightContainer.style.cssText="top: "+-b+"px",a.copyLeftContainer.style.cssText="top: "+-c+"px"}function m(a,b,c,d,e){var f={},g=/^\n/.test(e);if(b===G.DIFF_INSERT){var h=n(a.editors.left,c,e),i=q(a.editors.right,d),j=o(a.editors.right,i),k=o(a.editors.left,h.startLine),l=o(a.editors.left,h.startLine),m=i;0===l&&g&&(g=!1),0===h.startChar&&r(a.editors.right,d,g)&&(m=i+1);var p=h.startLine===h.endLine,s=0;(h.startChar>0||p&&e.length<k)&&j>0&&h.startChar<k&&s++,f={leftStartLine:h.startLine,leftEndLine:h.endLine+1,rightStartLine:m,rightEndLine:m+s}}else{var h=n(a.editors.right,d,e),i=q(a.editors.left,c),j=o(a.editors.left,i),t=o(a.editors.right,h.startLine),l=o(a.editors.right,h.startLine),u=i;0===l&&g&&(g=!1),0===h.startChar&&r(a.editors.left,c,g)&&(u=i+1);var p=h.startLine===h.endLine,s=0;(h.startChar>0||p&&e.length<t)&&j>0&&h.startChar<t&&s++,f={leftStartLine:u,leftEndLine:u+s,rightStartLine:h.startLine,rightEndLine:h.endLine+1}}return f}function n(a,b,c){var d={startLine:0,startChar:0,endLine:0,endChar:0},e=b+c.length,f=0,g=!1,h=!1;a.lineLengths.forEach(function(a,c){f+=a,!g&&f>b&&(d.startLine=c,d.startChar=b-f+a,g=!0),!h&&f>=e&&(d.endLine=c,d.endChar=e-f+a,h=!0)}),d.startChar>0&&o(a,d.startLine)===d.startChar&&(d.startLine++,d.startChar=0),0===d.endChar&&d.endLine--;var i=/\n$/.test(c);return d.startChar>0&&i&&d.endLine++,d}function o(a,b){return p(a,b).length}function p(a,b){return a.ace.getSession().doc.getLine(b)}function q(a,b){for(var c=a.ace.getSession().doc.getAllLines(),d=0,e=0,f=0;f<c.length;f++)if(e+=c[f].length+1,e>=b){d=f;break}return d}function r(a,b,c){for(var d=a.ace.getSession().doc.getAllLines(),e=0,f=!1,g=0;g<d.length;g++){e+=d[g].length+1;var h=e;if(c&&h--,b===h){f=!0;break}}return f}function s(a){var b=document.createElement("div"),c={"class":a.className,style:"top:"+a.topOffset+"px",title:a.tooltip,"data-diff-index":a.diffIndex};for(var d in c)b.setAttribute(d,c[d]);return b.innerHTML=a.arrowContent,b}function t(a){a.gutterHeight=document.getElementById(a.options.classes.gutterID).clientHeight,a.gutterWidth=document.getElementById(a.options.classes.gutterID).clientWidth;var b=u(a,G.EDITOR_LEFT),c=u(a,G.EDITOR_RIGHT),d=Math.max(b,c,a.gutterHeight);a.gutterSVG=document.createElementNS(G.SVG_NS,"svg"),a.gutterSVG.setAttribute("width",a.gutterWidth),a.gutterSVG.setAttribute("height",d),document.getElementById(a.options.classes.gutterID).appendChild(a.gutterSVG)}function u(a,b){var c=b===G.EDITOR_LEFT?a.editors.left:a.editors.right;return c.ace.getSession().getLength()*a.lineHeight}function v(a){a.copyRightContainer=document.createElement("div"),a.copyRightContainer.setAttribute("class",a.options.classes.copyRightContainer),a.copyLeftContainer=document.createElement("div"),a.copyLeftContainer.setAttribute("class",a.options.classes.copyLeftContainer),document.getElementById(a.options.classes.gutterID).appendChild(a.copyRightContainer),document.getElementById(a.options.classes.gutterID).appendChild(a.copyLeftContainer)}function w(a){var b=document.getElementById(a.options.classes.gutterID);b.removeChild(a.gutterSVG),t(a)}function x(a){a.copyLeftContainer.innerHTML="",a.copyRightContainer.innerHTML=""}function y(a,b){function c(b){return a.options.diffGranularity===G.DIFF_GRANULARITY_SPECIFIC?1>b:1>=b}var d=[];b.forEach(function(a,b){if(0===b)return void d.push(a);for(var e=!1,f=0;f<d.length;f++)if(c(Math.abs(a.leftStartLine-d[f].leftEndLine))&&c(Math.abs(a.rightStartLine-d[f].rightEndLine))){d[f].leftStartLine=Math.min(a.leftStartLine,d[f].leftStartLine),d[f].rightStartLine=Math.min(a.rightStartLine,d[f].rightStartLine),d[f].leftEndLine=Math.max(a.leftEndLine,d[f].leftEndLine),d[f].rightEndLine=Math.max(a.rightEndLine,d[f].rightEndLine),e=!0;break}e||d.push(a)});var e=[];return d.forEach(function(a){(a.leftStartLine!==a.leftEndLine||a.rightStartLine!==a.rightEndLine)&&e.push(a)}),e}function z(a){w(a),x(a),a.diffs.forEach(function(a,b){this.options.showDiffs&&(g(this,G.EDITOR_LEFT,a.leftStartLine,a.leftEndLine,this.options.classes.diff),g(this,G.EDITOR_RIGHT,a.rightStartLine,a.rightEndLine,this.options.classes.diff),this.options.showConnectors&&j(this,a.leftStartLine,a.leftEndLine,a.rightStartLine,a.rightEndLine),k(this,a,b))},a)}function A(){var a,b,c,d,e,f,g=arguments[0]||{},h=1,i=arguments.length,j=!1,k=Object.prototype.toString,l=Object.prototype.hasOwnProperty,m={"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object Array]":"array","[object Date]":"date","[object RegExp]":"regexp","[object Object]":"object"},n={isFunction:function(a){return"function"===n.type(a)},isArray:Array.isArray||function(a){return"array"===n.type(a)},isWindow:function(a){return null!==a&&a===a.window},isNumeric:function(a){return!isNaN(parseFloat(a))&&isFinite(a)},type:function(a){return null===a?String(a):m[k.call(a)]||"object"},isPlainObject:function(a){if(!a||"object"!==n.type(a)||a.nodeType)return!1;try{if(a.constructor&&!l.call(a,"constructor")&&!l.call(a.constructor.prototype,"isPrototypeOf"))return!1}catch(b){return!1}var c;for(c in a);return void 0===c||l.call(a,c)}};for("boolean"==typeof g&&(j=g,g=arguments[1]||{},h=2),"object"==typeof g||n.isFunction(g)||(g={}),i===h&&(g=this,--h),h;i>h;h++)if(null!==(a=arguments[h]))for(b in a)c=g[b],d=a[b],g!==d&&(j&&d&&(n.isPlainObject(d)||(e=n.isArray(d)))?(e?(e=!1,f=c&&n.isArray(c)?c:[]):f=c&&n.isPlainObject(c)?c:{},g[b]=A(j,f,d)):void 0!==d&&(g[b]=d));return g}function B(a){return document.getElementById(a.options.left.id).offsetHeight}function C(a,b,c,d){var e=c-a,f=a+e/2,g="M "+a+" "+b+" C "+f+","+b+" "+f+","+d+" "+c+","+d;return g}function D(a,b,c,d){var e="document"===a?document:document.querySelector(a);e.addEventListener(b,function(a){for(var b=e.querySelectorAll(c),f=a.target,g=0,h=b.length;h>g;g++)for(var i=f,j=b[g];i&&i!==e;){if(i===j)return d.call(j,a);i=i.parentNode}})}function E(a,b,c){var d;return function(){var e=this,f=arguments,g=function(){d=null,c||a.apply(e,f)},h=c&&!d;clearTimeout(d),d=setTimeout(g,b),h&&a.apply(e,f)}}var F=require("ace/range").Range,G={DIFF_EQUAL:0,DIFF_DELETE:-1,DIFF_INSERT:1,EDITOR_RIGHT:"right",EDITOR_LEFT:"left",RTL:"rtl",LTR:"ltr",SVG_NS:"http://www.w3.org/2000/svg",DIFF_GRANULARITY_SPECIFIC:"specific",DIFF_GRANULARITY_BROAD:"broad"};return a.prototype={setOptions:function(a){A(!0,this.options,a),this.diff()},getNumDiffs:function(){return this.diffs.length},getEditors:function(){return{left:this.editors.left.ace,right:this.editors.right.ace}},diff:function(){var a=new diff_match_patch,b=this.editors.left.ace.getSession().getValue(),c=this.editors.right.ace.getSession().getValue(),d=a.diff_main(c,b);a.diff_cleanupSemantic(d),this.editors.left.lineLengths=f(this.editors.left),this.editors.right.lineLengths=f(this.editors.right);var e=[],g={left:0,right:0};d.forEach(function(a){var b=a[0],c=a[1];0!==c.length&&(b===G.DIFF_EQUAL?(g.left+=c.length,g.right+=c.length):b===G.DIFF_DELETE?(e.push(m(this,G.DIFF_DELETE,g.left,g.right,c)),g.right+=c.length):b===G.DIFF_INSERT&&(e.push(m(this,G.DIFF_INSERT,g.left,g.right,c)),g.left+=c.length))},this),this.diffs=y(this,e),this.diffs.length>this.options.maxDiffs||(i(this),z(this))},destroy:function(){var a=this.editors.left.ace.getValue();this.editors.left.ace.destroy();var b=this.editors.left.ace.container,c=b.cloneNode(!1);c.textContent=a,b.parentNode.replaceChild(c,b);var d=this.editors.right.ace.getValue();this.editors.right.ace.destroy(),b=this.editors.right.ace.container,c=b.cloneNode(!1),c.textContent=d,b.parentNode.replaceChild(c,b),document.getElementById(this.options.classes.gutterID).innerHTML=""}},a});